{
    "variables": {
        "app_user": "node",
        "version": "develop",
        "tag": "develop",
        "enable_logging":"false",
        "dev_env": "false",
        "docker_registry": "oneledger/chronos",
        "systemd_service": "false"
    },
    "builders": [
        {
            "type": "docker",
            "name": "docker-image",
            "image": "debian",
            "commit": true,
            "changes": [
                "USER {{user `app_user`}}",
                "ENTRYPOINT [\"/usr/local/bin/fullnodeStartup\"]",
                "CMD [\"/bin/bash\"]",
                "VOLUME /home/{{user `app_user`}}/go"
            ]
        },
        {
            "type": "googlecompute",
            "name": "gcp-vm-image",
            "image_name": "fullnode-{{user `tag` | clean_image_name }}",
            "account_file": "./gcp/DevNet.json",
            "project_id": "atomic-land-223022",
            "source_image_family": "ubuntu-1604-lts",
            "ssh_username": "steven",
            "zone": "us-east1-b",
            "machine_type": "n1-highcpu-8",
            "disk_size": "50",
            "use_internal_ip": false
        }
    ],
  
    "provisioners": [
        {
            "type": "shell",
            "inline_shebang": "/bin/bash",
            "inline": [
                "source /etc/os-release",
                "if [[ \"$NAME\" = \"Debian GNU/Linux\" ]];then",
                "   apt update -y && apt install -y python-pip",
                "   pip install ansible",
                "   ansible-galaxy install gantsign.golang",
                "else",
                "   sudo apt update -y && sudo apt install -y python-pip",
                "   sudo pip install ansible",
                "   ansible-galaxy install gantsign.golang",
                "fi"
            ]
        },
        {
            "type": "ansible-local",
            "playbook_file": "ansible/fullnode.yml",
            "command": "ansible-playbook -v",
            "role_paths": ["ansible/roles/logstash","ansible/roles/fullnode"],
            "extra_arguments": ["--extra-vars \"systemd_service={{user `systemd_service` }} enable_logging={{user `enable_logging`}} dev_env={{user `dev_env`}} app_user={{user `app_user`}} app_version={{user `version`}}\""]
        }
    ],
    "post-processors": [
        {
            "type": "docker-tag",
            "repository": "{{user `docker_registry`}}",
            "tag": "{{user `tag`}}",
            "only": ["docker-image"]
        },
        {
            "type": "googlecompute-export",
            "machine_type": "n1-highcpu-8",
            "zone": "us-east1-b",
            "paths": [
                "gs://oneledger-fullnode-images/{{user `tag`}}.tar.gz"
            ],
            "keep_input_artifact": true,
            "only": ["gcp-vm-image"]
        }
    ]
  }