language: go
go:
- 1.11.x
addons:
  apt:
    update: true
    package:
    - python
    - python-pip
  ssh_known_hosts:
  - 35.203.59.66
  - 35.203.120.202
  - 35.203.52.149
  - 35.203.102.115
  - 35.203.106.138
  - 35.203.114.25
  - 35.231.92.23
  - 35.245.22.61
  - 35.202.9.190
  - 104.196.156.5
  - 35.245.204.124

before_install:
- export OLDATA=$GOPATH/test
- export OLROOT=$GOPATH/src/github.com/Oneledger
- export OLSCRIPT=$OLROOT/protocol/node/scripts
- export OLSETUP=$OLROOT/protocol/node/setup
- export OLTEST=$OLROOT/protocol/node/tests
- export GO111MODULE="on"
- export PATH=$PATH:$GOPATH/bin
- export OLDEBUG=true
- openssl aes-256-cbc -K $encrypted_64046c0b275a_key -iv $encrypted_64046c0b275a_iv
  -in $TRAVIS_BUILD_DIR/.secrets.tar.enc -out $TRAVIS_BUILD_DIR/secrets.tar -d
- cd $TRAVIS_BUILD_DIR && tar xvf secrets.tar
- chmod 600 DevNet.json id_rsa
- eval $(ssh-agent -s)
- ssh-add $TRAVIS_BUILD_DIR/id_rsa
- cd $TRAVIS_BUILD_DIR && git clone git@github.com:Oneledger/infrastructure.git --branch
  master
- sudo apt-get install unzip
- wget https://releases.hashicorp.com/terraform/0.11.13/terraform_0.11.13_linux_amd64.zip
- unzip terraform_0.11.13_linux_amd64.zip
- sudo mv terraform /usr/local/bin/
- cp $TRAVIS_BUILD_DIR/DevNet.json $TRAVIS_BUILD_DIR/infrastructure/gcp

install:
- sudo pip install netaddr
- sudo pip install ipaddr
- sudo pip install cryptography==2.2.2
- sudo pip install ansible
script:
- cd $OLROOT/protocol/node && make update
- cd $OLROOT/protocol/node && make install
- cd $OLROOT/protocol/node && make fulltest
- cd $TRAVIS_BUILD_DIR/infrastructure/ansible && ansible-playbook main.yml -v --extra-vars "reset_network=true"
deploy:
- provider: releases
  skip_cleanup: true
  prerelease: true
  draft: true
  api_key:
    secure: 2bnCcsdf5wf6zOYTJoYhunhzilLVFHL0ToSoVo8hXpaCsBtGGbO74uA3lustVSIbfrcKfE6XNMB0rOqUujEZiUtL2YvowTOFi/XuhNYO3IC9G+jdo5miCvh6PRo0O/eSsz2gluTIKPp8MPTvqfeWExgPvtUDYp9XDbRn8Pi2DPrdJ5JHmAusVVzYnVfulUjlah8yHsgLEkGlLFS0m/E1QudvlM8bqEIOnDKY4E+PdXANaWQSqNwj2rYlC2OqMSAUucvCsPENLtAuaWOo8/GJXlJqGTJr4cQNgZs+cA0CGicgnlmkmMtV7p3Cxtdactj7I5irkNCdL0YIRHwL8THo1xuWjTtqugxeDqcOHMPnGVKaCtbh0mzVzGuQTS3B5B3Ihp03JeZVq6rjGIKrYyTSjV2nD0HiCpKWb4rm4MQc2OFPoMqmmMWX4eKGp2sa04pF0v1NXK98B0qtUHgt2u/Zd+HjT8X4LoMiuh1g+6+DkGzSaQK8gSRd3B1rW/bx7ucJtQV+nb/nnfKvd2zLT6Z8WUuycJwkt+lA3jxDhiXm5apq8UN8zw/9JhAwjU04ID+gKNkjp3CALf5QlvBATT5PHSW+HrqLeS8wBwdjOVRBR8i1Rn0tFjsFhfQRFKhPSoVm3l1BfI23B2vLfN047pGtUceCzq55t2yD4IaSa+67go0=
  file_glob: true
  file: "$GOPATH/bin/*"
  on:
    repo: Oneledger/protocol
    tags: true
- provider: script
  skip_cleanup: true
  script: cd $TRAVIS_BUILD_DIR/ansible && ansible-playbook main.yml -i 'devnet.yml'
    --private-key /tmp/id_rsa -v --extra-vars "reset_network=true"
  on:
    branch: develop
env:
  global:
  - secure: OlMvgZRitZeaBGKmKr+D4BT/p8zSvR3I1xbCEE8HLmosOxd6n+C00wgUvnBed83dojeeN1uR/PYuJfHvqvNCEimO9+uhOZ/Y6cL7/97xku968GbOKrvSJa5AuutPEpbw9Ilnh1TJhN5x8Esoda8AG93OZG2IqafmZkBVwlIWGqKO6cm1AHLjZXHMUhOGGDPE2d8lMq3X/yhQLqWtFBboDWUZlcDoK5iNR8vDCAoQpD2BBJMv1X7wMkJTucnxOZkhoq/bFcWGO+qLzVfeEWwGIAwpFMEtbVRoE9sKIvLLd20jwPgMdRoEbKsFJRhGARYkBaVFDcSSeppHVlCYXmHdl33WCuQXnv+DtCLchtqO5C/KvFq1Bcvx3dGuhEjv3SJbJsq0s2MXiTUY/mDiian7ytaDe9BacEveIzkNK3VKggYMaoeLW8SyQE7Mvbe0ZM8L15/WG5ognhJg54knxiePgL5qhBVvxtbwtEGQzM6O/ELC80vnsIZdp7OmFNItRKgKO2vWUGaxzYpTbOdYn7bBOzeS+mtlkRletoEWh2YhQgqxBs4duZPvgzV2AzEclIK5jwx35Ec35BaB9fOB3scff4Km21Sv4OO51DOdhWi5Sp/V1Idjo4z3Hhtyn45RgBY2J7OPNYA9JQAdgH53Hth1GD1oF64tZ47BWleAUAu17Xs=
  - secure: uiTQJs6ZINBl2aGjtYImp4oMzf5SRPqwoE9CsRzexnhj3HMi3iDe7xcrJ69PQI///lrGNmfa/wU2YWmsuiWZynJ41dsN6xTPmbubLBlxMzqeeLIbkSkvZ5ttwAkr3aJ3zf4I1VaeFdE6t0dHDtQil2sEZ0VpaBv/YtYGcNDFuiq0v+4aqqooJeEVDI72MxBY4L7z4tc69axHMyp6Yl5/TLkJIaii4LWTrRjfjmaxGUQc8M0J8erdyTN/3MPOu8sQ9zVeUULchHxtdaxjGiCBWXwKngDPx+3nN3M+4rCsVeeZVKgajag9GcixHiNErvzpZ9eV5i4j3496/2vh5VJGAdTe/rGMWc3V4YP0byqVHdDu9aZhnqj2Mp6rOJOsBZ0G3kHoLKc274m7crhBZAOc02yzpv7pdmclRtkM/YoyjYzfVsdDdpLJruRXpOuAfCqUYmKYTEuP7RiS9AvSd+TK9UtACsMAQ/+FIlYtCFQ/eBkaEfQ5rtGBuMwpCGrs0/edNhXCkMB1LhWUO+gYLKOyS+/p0wkHONOE5s43i8r2f3It2lYaoe17TVqEjsnajEHeV2SapNtyQQOsP3VhoEE7w1K8ThF4ESDt11LWAt7KsJOfqP/5H/wev9xXkzOZxnBB6WLex56Vy/rgl4NpjSKHp6jI+5e+ZKfpvEacu08/Kis=
 