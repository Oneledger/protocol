/*
	Copyright 2017-2018 OneLedger

	The overall running context. Initialized right away, but is mutable.

	Contains the main variables.

	Precedence:
		- Default values
	 	- Environment variables (like $OLROOT)
		- Configuration files
		- Command line arguments
		- Overrides
*/
package global

import (
	"os"
	"path/filepath"

	"github.com/Oneledger/protocol/node/config"
	"github.com/Oneledger/protocol/node/persist"
	"github.com/mitchellh/go-homedir"
	tmnode "github.com/tendermint/tendermint/node"
	"github.com/tendermint/tendermint/types"
)

var Current *Context

type Context struct {
	Application persist.Access // Global Access to the application when it is running

	chainID string

	Debug            bool // DEBUG flag
	DisablePasswords bool // DEBUG flag

	NodeName        string // Name of this instance
	NodeAccountName string // TODO: Should be a list of accounts
	PaymentAccount  string
	NodeIdentity    string
	RootDir         string // Working directory for this instance

	// Do we really need this?
	Sequence int64 // replay protection

	// This should be set to a function, shouldn't be specifiable
	TendermintAddress string
	TendermintPubKey  string

	PersistentPeers []string
	Seeds           string
	SeedMode        bool
	P2PAddress      string

	ConsensusNode *tmnode.Node

	//Minimum Fees
	MinSendFee     float64
	MinSwapFee     float64
	MinContractFee float64
	MinRegisterFee float64

	Config *config.Server
}

func init() {
	Current = NewContext("OneLedger")
}

// Set the default values for any context variables here
func NewContext(name string) *Context {
	var debug = false
	if os.Getenv("OLDEBUG") == "true" {
		debug = true
	}

	defaultRootDir := os.Getenv("OLDATA")
	if defaultRootDir == "" {
		home, _ := homedir.Dir()
		defaultRootDir = filepath.Join(home, ".olfullnode")
	}

	return &Context{
		Debug:            debug,
		DisablePasswords: true,

		NodeName:        name,
		NodeAccountName: "",
		PaymentAccount:  "Payment",
		RootDir:         defaultRootDir,

		// TODO: Should be params in the chain
		MinSendFee:     0.1,
		MinSwapFee:     0.1,
		MinContractFee: 0.1,
		MinRegisterFee: 0.1,
		Config:         config.DefaultServerConfig(),
	}
}

// ChainID returns the chainID
func (ctx *Context) ChainID() string {
	return ctx.chainID
}

// SetChainID sets the current chain ID, its value should always come from the genesis file
func (ctx *Context) SetChainID(doc *types.GenesisDoc) {
	ctx.chainID = doc.ChainID
}

func (ctx *Context) SetApplication(app persist.Access) persist.Access {
	ctx.Application = app
	return app
}

func (ctx *Context) SetConsensusNode(node *tmnode.Node) {
	ctx.ConsensusNode = node
}

func (ctx *Context) GetApplication() persist.Access {
	return ctx.Application
}

func (ctx *Context) ConsensusDir() string {
	result, _ := filepath.Abs(filepath.Join(Current.RootDir, "consensus"))
	return result
}

func (ctx *Context) DatabaseDir() string {
	result, _ := filepath.Abs(filepath.Join(Current.RootDir, "nodedata"))
	return result
}

// ReadConfig looks for a configuration file in the rootdir
func (ctx *Context) ReadConfig() error {
	var cfg config.Server
	err := cfg.ReadFile(filepath.Join(ctx.RootDir, config.FileName))
	if err != nil {
		return err
	}
	ctx.Config = &cfg
	return nil
}

// SaveConfig writes the currently loaded configuration onto a config.toml file in the root directory
func (ctx *Context) SaveConfig() error {
	return ctx.Config.SaveFile(ctx.RootDir)
}
