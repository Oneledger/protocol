{
    "variables": {
        "app_user": "explorer",
        "ecr_endpoint": "260114726869.dkr.ecr.us-east-1.amazonaws.com",
        "tag": "develop"
    },
    "builders": [
        {
            "type": "docker",
            "image": "{{user `ecr_endpoint`}}/oneledger/explorer:latest",
            "ecr_login": true,
            "login_server": "{{user `ecr_endpoint`}}",
            "commit": true,
            "changes": [
                "USER {{user `app_user`}}",
                "EXPOSE 5432",
                "VOLUME  [\"/etc/postgresql\", \"/var/log/postgresql\", \"/var/lib/postgresql\"]", 
                "CMD [\"/usr/lib/postgresql/9.3/bin/postgres\", \"-D\", \"/var/lib/postgresql/9.3/main\", \"-c\", \"config_file=/etc/postgresql/9.3/main/postgresql.conf\"]"
            ]
        }
    ],
    "provisioners": [
        {
            "type": "shell",
            "inline_shebang": "/bin/bash",
            "inline": [
                "apt update -y && apt install -y python-pip",
                "pip install ansible"
            ]
        },
        {
            "type": "ansible-local",
            "playbook_file": "ansible/postgres_sql.yml",
            "command": "ansible-playbook -vvv"
        }
    ],
    "post-processors": [
        {
            "type": "docker-tag",
            "repository": "{{user `ecr_endpoint`}}",
            "tag": "{{user `tag`}}"
        }
    ]
}